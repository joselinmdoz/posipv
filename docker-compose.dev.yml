# =============================================================================
# Docker Compose - Desarrollo
# Configuración completa para POS (Backend + Frontend + PostgreSQL)
# =============================================================================
# Uso: docker compose -f docker-compose.dev.yml up -d
# Puertos:
#   - PostgreSQL: 5421
#   - Backend API: 3021
#   - Frontend: 4200
# =============================================================================

services:
  # ---------------------------------------------------------------------------
  # Base de datos PostgreSQL 16
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:16
    container_name: pos_postgres_dev
    restart: unless-stopped
    environment:
      POSTGRES_DB: pos
      POSTGRES_USER: pos
      POSTGRES_PASSWORD: pos123
      # Configuración adicional para mejor rendimiento
      POSTGRES_INITDB_ARGS: "-E UTF8"
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5421:5432"
    volumes:
      - pos_pgdata_dev:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U pos -d pos"]
      interval: 10s
      timeout: 5s
      retries: 5
    networks:
      - pos_network

  # ---------------------------------------------------------------------------
  # Backend NestJS (API)
  # ---------------------------------------------------------------------------
  api:
    build:
      context: ./pos_api
      dockerfile: Dockerfile
    container_name: pos_api_dev
    restart: unless-stopped
    environment:
      NODE_ENV: development
      DATABASE_URL: "postgresql://pos:pos123@postgres:5432/pos?schema=public"
      JWT_SECRET: "CAMBIA_ESTO_POR_ALGO_LARGO_Y_SERIO_EN_PRODUCCION"
      PORT: 3021
      CORS_ORIGIN: "http://localhost:4200,http://127.0.0.1:4200"
    ports:
      - "3021:3021"
    volumes:
      # Montar código fuente para hot-reload
      - ./pos_api:/app
      - /app/node_modules
      # Volumen para uploads
      - pos_uploads_dev:/app/uploads
    depends_on:
      postgres:
        condition: service_healthy
    # El comando se especifica en el Dockerfile
    networks:
      - pos_network

  # ---------------------------------------------------------------------------
  # Frontend Angular
  # ---------------------------------------------------------------------------
  web:
    build:
      context: ./pos_web
      dockerfile: Dockerfile
    container_name: pos_web_dev
    restart: unless-stopped
    environment:
      NODE_ENV: development
    ports:
      - "4200:4200"
    volumes:
      # Montar código fuente para hot-reload
      - ./pos_web:/app
      - /app/node_modules
    depends_on:
      - api
    # Angular serve ya incluye hot-reload
    networks:
      - pos_network

# -------------------------------------------------------------------------------
# Redes
# -------------------------------------------------------------------------------
networks:
  pos_network:
    driver: bridge

# -------------------------------------------------------------------------------
# Volúmenes persistentes
# -------------------------------------------------------------------------------
volumes:
  pos_pgdata_dev:
    name: pos_pgdata_dev
  pos_uploads_dev:
    name: pos_uploads_dev
