import{a as Z}from"./chunk-P5KSWAQ2.js";import{a as j}from"./chunk-YWTIGOUW.js";import{d as A,e as R}from"./chunk-EKOQI3CN.js";import{a as Y}from"./chunk-W4NJFJ3E.js";import{a as L}from"./chunk-IJJ5UOPG.js";import{a as $}from"./chunk-BSNL7NNX.js";import{a as z}from"./chunk-OGHJEGVW.js";import{a as B,b as U,c as G,d as q,e as H,f as J,g as K,h as Q,j as X}from"./chunk-5CMZHIZT.js";import"./chunk-XZ3PRBQD.js";import{Aa as V,Ea as x,Ka as g,La as i,Ma as n,N as v,Oa as b,Pa as u,Qa as c,S as p,T as m,Va as T,Ya as a,Za as w,_a as y,ab as f,ba as _,bb as h,cb as C,eb as S,gb as E,hb as k,ib as N,j as P,kb as O,pa as l,v as M,wb as I,xb as W,yb as D,zb as F}from"./chunk-EVJ26B7U.js";var te=()=>[1,5,10,20,50,100];function ne(s,o){if(s&1){let e=b();i(0,"div",20)(1,"button",21),u("click",function(){p(e);let t=c().$implicit,d=c();return m(d.configure(t))}),a(2,"Configurar"),n(),i(3,"button",21),u("click",function(){p(e);let t=c().$implicit,d=c();return m(d.edit(t))}),a(4,"Editar"),n(),i(5,"button",21),u("click",function(){p(e);let t=c().$implicit,d=c();return m(d.delete(t))}),a(6,"Eliminar"),n()()}}function ie(s,o){if(s&1){let e=b();i(0,"div",11)(1,"div",12)(2,"div",13)(3,"button",14),u("click",function(){let t=p(e).$implicit,d=c();return m(d.toggleMenu(t.id))}),a(4,"\u22EE"),n(),x(5,ne,7,0,"div",15),n()(),i(6,"div",16)(7,"div",17),a(8),n(),i(9,"div",18)(10,"code"),a(11),n()(),i(12,"button",19),u("click",function(){let t=p(e).$implicit,d=c();return m(d.select(t))}),a(13,"Iniciar Sesi\xF3n"),n()()()}if(s&2){let e=o.$implicit,r=c();l(5),g("ngIf",r.openMenu()===e.id),l(3),w(e.name),l(3),w(e.code)}}function oe(s,o){s&1&&(i(0,"span",3),a(1,"Guardando\u2026"),n())}function re(s,o){if(s&1){let e=b();i(0,"div",22)(1,"div",23)(2,"div",24)(3,"h3"),a(4,"Crear TPV"),n(),i(5,"button",25),u("click",function(){p(e);let t=c();return m(t.closeModals())}),a(6,"\xD7"),n()(),i(7,"div",26)(8,"div",27)(9,"label")(10,"span"),a(11,"Nombre"),n(),i(12,"input",28),C("ngModelChange",function(t){p(e);let d=c();return h(d.newName,t)||(d.newName=t),m(t)}),n()(),i(13,"div",29)(14,"button",30),u("click",function(){p(e);let t=c();return m(t.create())}),a(15,"Guardar"),n(),x(16,oe,2,0,"span",10),n()()()()()}if(s&2){let e=c();l(12),f("ngModel",e.newName),l(2),g("disabled",e.busy()||!e.newName),l(2),g("ngIf",e.busy())}}function ae(s,o){s&1&&(i(0,"span",3),a(1,"Guardando\u2026"),n())}function se(s,o){if(s&1){let e=b();i(0,"div",22)(1,"div",23)(2,"div",24)(3,"h3"),a(4,"Editar TPV"),n(),i(5,"button",25),u("click",function(){p(e);let t=c();return m(t.closeModals())}),a(6,"\xD7"),n()(),i(7,"div",26)(8,"div",27)(9,"label")(10,"span"),a(11,"Nombre"),n(),i(12,"input",28),C("ngModelChange",function(t){p(e);let d=c();return h(d.newName,t)||(d.newName=t),m(t)}),n()(),i(13,"div",29)(14,"button",30),u("click",function(){p(e);let t=c();return m(t.saveEdit())}),a(15,"Guardar"),n(),x(16,ae,2,0,"span",10),n()()()()()}if(s&2){let e=c();l(12),f("ngModel",e.newName),l(2),g("disabled",e.busy()||!e.newName),l(2),g("ngIf",e.busy())}}function le(s,o){if(s&1&&(i(0,"p",3),a(1,"Configuraci\xF3n para: "),i(2,"b"),a(3),n()()),s&2){let e=c(2);l(3),w(e.configTPV.name)}}function de(s,o){if(s&1){let e=b();i(0,"label",36)(1,"input",41),C("ngModelChange",function(t){p(e);let d=c(2);return h(d.configDenominations,t)||(d.configDenominations=t),m(t)}),n(),a(2),n()}if(s&2){let e=o.$implicit,r=c(2);l(),f("ngModel",r.configDenominations),g("value",e),l(),y(" ",e," ")}}function ce(s,o){s&1&&(i(0,"span",3),a(1,"Guardando\u2026"),n())}function pe(s,o){if(s&1){let e=b();i(0,"div",22)(1,"div",23)(2,"div",24)(3,"h3"),a(4,"Configurar TPV"),n(),i(5,"button",25),u("click",function(){p(e);let t=c();return m(t.closeModals())}),a(6,"\xD7"),n()(),i(7,"div",26),x(8,le,4,1,"p",10),i(9,"div",27)(10,"label")(11,"span"),a(12,"Tipo de moneda"),n(),i(13,"select",31),C("ngModelChange",function(t){p(e);let d=c();return h(d.configCurrency,t)||(d.configCurrency=t),m(t)}),i(14,"option",32),a(15,"CUP - Peso cubano"),n(),i(16,"option",33),a(17,"USD - D\xF3lar estadounidense"),n()()(),i(18,"label")(19,"span"),a(20,"Almac\xE9n"),n(),i(21,"span",34),a(22),n()(),i(23,"label")(24,"span"),a(25,"M\xE9todos de pago"),n(),i(26,"div",35)(27,"label",36)(28,"input",37),C("ngModelChange",function(t){p(e);let d=c();return h(d.configPaymentMethods,t)||(d.configPaymentMethods=t),m(t)}),n(),a(29," Efectivo "),n(),i(30,"label",36)(31,"input",38),C("ngModelChange",function(t){p(e);let d=c();return h(d.configPaymentMethods,t)||(d.configPaymentMethods=t),m(t)}),n(),a(32," Transferencia "),n(),i(33,"label",36)(34,"input",39),C("ngModelChange",function(t){p(e);let d=c();return h(d.configPaymentMethods,t)||(d.configPaymentMethods=t),m(t)}),n(),a(35," Tarjeta "),n()()(),i(36,"label")(37,"span"),a(38,"Denominaciones"),n(),i(39,"div",35),x(40,de,3,3,"label",40),n()(),i(41,"div",29)(42,"button",30),u("click",function(){p(e);let t=c();return m(t.saveConfig())}),a(43,"Guardar"),n(),x(44,ce,2,0,"span",10),n()()()()()}if(s&2){let e=c();l(8),g("ngIf",e.configTPV),l(5),f("ngModel",e.configCurrency),l(9),w(e.configWarehouseName()),l(6),f("ngModel",e.configPaymentMethods),l(3),f("ngModel",e.configPaymentMethods),l(3),f("ngModel",e.configPaymentMethods),l(6),g("ngForOf",S(9,te)),l(2),g("disabled",e.busy()),l(2),g("ngIf",e.busy())}}function me(s,o){if(s&1){let e=b();i(0,"div",44),a(1),E(2,"date"),i(3,"div",45),a(4,"ID: "),i(5,"code"),a(6),n()(),i(7,"button",5),u("click",function(){p(e);let t=c(2);return m(t.goPos())}),a(8,"Ir al POS"),n()()}if(s&2){let e,r,t=c(2);l(),y(" \u2705 Sesi\xF3n abierta (",k(2,2,(e=t.openSession())==null?null:e.openedAt,"short"),") "),l(5),w((r=t.openSession())==null?null:r.id)}}function ge(s,o){if(s&1&&(i(0,"p",51),a(1),n()),s&2){let e=c(3);l(),w(e.err())}}function ue(s,o){if(s&1){let e=b();i(0,"div",6)(1,"label")(2,"span"),a(3,"Monto inicial (fijo)"),n(),i(4,"input",46),C("ngModelChange",function(t){p(e);let d=c(2);return h(d.opening,t)||(d.opening=t),m(t)}),n(),i(5,"small",47),a(6,"Se configura por caja en "),i(7,"a",48),a(8,"Configuraci\xF3n"),n(),a(9,"."),n()(),i(10,"label")(11,"span"),a(12,"Nota (opcional)"),n(),i(13,"input",49),C("ngModelChange",function(t){p(e);let d=c(2);return h(d.note,t)||(d.note=t),m(t)}),n()()(),i(14,"button",30),u("click",function(){p(e);let t=c(2);return m(t.open())}),a(15),n(),x(16,ge,2,1,"p",50)}if(s&2){let e=c(2);l(4),f("ngModel",e.opening),g("disabled",!e.isAdmin()),l(9),f("ngModel",e.note),l(),g("disabled",e.busy()),l(),w(e.busy()?"Abriendo\u2026":"Abrir caja"),l(),g("ngIf",e.err())}}function _e(s,o){if(s&1&&(i(0,"div",42)(1,"h3"),a(2,"Sesi\xF3n de caja"),n(),x(3,me,9,5,"div",43)(4,ue,17,6,"ng-template",null,0,N),n()),s&2){let e=T(5),r=c();l(3),g("ngIf",r.openSession())("ngIfElse",e)}}function xe(s,o){s&1&&(i(0,"p",3),a(1,"Tip: si tienes varias cajas f\xEDsicas, dales un nombre claro (Caja 1, Caja 2\u2026)."),n())}var ee=class s{regService=v(L);cashService=v(Y);settings=v(Z);warehouses=v($);auth=v(j);router=v(A);toast=v(z);registers=_([]);warehousesList=_([]);selectedId=this.regService.selectedId;openSession=_(null);busy=_(!1);err=_("");opening=100;note="";showNew=_(!1);newName="";newCode="";openMenu=_(null);showEditModal=_(!1);showConfigModal=_(!1);editingTPV=null;configTPV=null;configWarehouseId="";configWarehouseName=_("");configCurrency="CUP";configPaymentMethods=[];configDenominations=[];isAdmin=O(()=>this.auth.user()?.role==="ADMIN");constructor(){this.refresh(),this.warehouses.list().pipe(M(()=>P([]))).subscribe(o=>this.warehousesList.set(o)),document.addEventListener("click",o=>{let e=o.target;!e.closest(".menu")&&!e.closest(".menu-btn")&&this.openMenu.set(null)})}refresh(){this.regService.list().subscribe({next:o=>{this.registers.set(o);let e=this.selectedId();e&&(o.some(t=>t.id===e)?this.loadOpenSession(e):this.regService.clear())},error:()=>this.err.set("No se pudieron cargar las cajas.")})}select(o){this.err.set(""),this.regService.select(o.id),this.loadOpenSession(o.id)}loadOpenSession(o){this.openSession.set(null),this.settings.getRegisterSettings(o).pipe(M(()=>P(null))).subscribe(e=>{e&&typeof e.defaultOpeningFloat=="number"&&(this.opening=e.defaultOpeningFloat)}),this.cashService.getOpen(o).subscribe({next:e=>this.openSession.set(e),error:()=>this.err.set("No se pudo verificar la sesi\xF3n de caja.")})}open(){let o=this.selectedId();o&&(this.err.set(""),this.busy.set(!0),this.cashService.open(o,Number(this.opening),this.note||void 0).subscribe({next:e=>{this.openSession.set(e),this.busy.set(!1)},error:e=>{this.busy.set(!1);let r=e?.error?.message;this.err.set(Array.isArray(r)?r.join(", "):r||"No se pudo abrir la caja.")}}))}goPos(){this.router.navigateByUrl("/pos")}toggleNew(){this.showNew.set(!this.showNew())}create(){this.newName&&(this.busy.set(!0),this.regService.create({name:this.newName}).subscribe({next:o=>{this.toast.push({kind:"success",title:"TPV creado",message:o.name}),this.newName="",this.newCode="",this.showNew.set(!1),this.refresh(),this.busy.set(!1)},error:o=>{console.error("Error creating TPV:",o),this.toast.push({kind:"error",title:"Error",message:"No se pudo crear el TPV"}),this.busy.set(!1)}}))}toggleMenu(o){this.openMenu.set(this.openMenu()===o?null:o)}configure(o){this.configTPV=o,this.configWarehouseId="",this.configWarehouseName.set("Cargando..."),this.configCurrency="CUP",this.configPaymentMethods=["EFECTIVO","TRANSFERENCIA"],this.configDenominations=[1,5,10,20,50,100],this.settings.getRegisterSettings(o.id).pipe(M(()=>P(null))).subscribe(e=>{this.configWarehouseId=e?.warehouseId||"",this.configWarehouseName.set(this.getWarehouseName(this.configWarehouseId)),this.configCurrency=e?.currency||"CUP",this.configPaymentMethods=e?.paymentMethods?.filter(r=>r.enabled).map(r=>r.code)||[],this.configDenominations=e?.denominations?.filter(r=>r.enabled).map(r=>r.value)||[]}),this.showConfigModal.set(!0)}edit(o){this.editingTPV=o,this.newName=o.name,this.newCode=o.code,this.showEditModal.set(!0)}delete(o){confirm("\xBFEliminar TPV "+o.name+"? Esta acci\xF3n no se puede deshacer.")&&this.regService.delete(o.id).subscribe({next:()=>{this.toast.push({kind:"success",title:"Eliminado",message:"TPV eliminado correctamente"}),this.refresh()},error:e=>{console.error("Error deleting TPV:",e),this.toast.push({kind:"error",title:"Error",message:"No se pudo eliminar el TPV"})}})}getWarehouseName(o){let e=this.warehousesList().find(r=>r.id===o);return e?e.name:"No asignado"}saveConfig(){this.configTPV&&this.settings.saveRegisterSettings(this.configTPV.id,{currency:this.configCurrency,warehouseId:this.configWarehouseId,paymentMethods:this.configPaymentMethods,denominations:this.configDenominations}).subscribe({next:()=>{this.showConfigModal.set(!1),this.toast.push({kind:"success",title:"Guardado",message:"Configuraci\xF3n actualizada"}),this.busy.set(!1)},error:()=>{this.toast.push({kind:"error",title:"Error",message:"No se pudo guardar"}),this.busy.set(!1)}})}saveEdit(){!this.editingTPV||!this.newName||(this.busy.set(!0),this.regService.update(this.editingTPV.id,{name:this.newName}).subscribe({next:o=>{this.toast.push({kind:"success",title:"TPV actualizado",message:o.name}),this.showEditModal.set(!1),this.refresh(),this.busy.set(!1)},error:o=>{console.error("Error updating TPV:",o),this.toast.push({kind:"error",title:"Error",message:"No se pudo actualizar el TPV"}),this.busy.set(!1)}}))}closeModals(){this.showNew.set(!1),this.showEditModal.set(!1),this.showConfigModal.set(!1),this.newName="",this.newCode="",this.editingTPV=null,this.configTPV=null}static \u0275fac=function(e){return new(e||s)};static \u0275cmp=V({type:s,selectors:[["ng-component"]],decls:16,vars:6,consts:[["openBox",""],[1,"wrap"],[1,"head"],[1,"muted"],[1,"actions"],[1,"btn","primary",3,"click"],[1,"grid"],["class","tpv-card",4,"ngFor","ngForOf"],["class","modal",4,"ngIf"],["class","panel",4,"ngIf"],["class","muted",4,"ngIf"],[1,"tpv-card"],[1,"card-header"],[1,"menu"],[1,"menu-btn",3,"click"],["class","dropdown",4,"ngIf"],[1,"card-body"],[1,"title"],[1,"code"],[1,"btn","primary","large",3,"click"],[1,"dropdown"],[3,"click"],[1,"modal"],[1,"modal-content"],[1,"modal-header"],[1,"close-btn",3,"click"],[1,"modal-body"],[1,"form"],["placeholder","Ej: TPV Principal",3,"ngModelChange","ngModel"],[1,"row"],[1,"btn","primary",3,"click","disabled"],[3,"ngModelChange","ngModel"],["value","CUP"],["value","USD"],[1,"warehouse-display"],[1,"checkbox-group"],[1,"checkbox-item"],["type","checkbox","value","EFECTIVO",3,"ngModelChange","ngModel"],["type","checkbox","value","TRANSFERENCIA",3,"ngModelChange","ngModel"],["type","checkbox","value","TARJETA",3,"ngModelChange","ngModel"],["class","checkbox-item",4,"ngFor","ngForOf"],["type","checkbox",3,"ngModelChange","ngModel","value"],[1,"panel"],["class","ok",4,"ngIf","ngIfElse"],[1,"ok"],[1,"small"],["type","number","step","0.01",3,"ngModelChange","ngModel","disabled"],[1,"hint"],["routerLink","/settings"],["placeholder","Ej: Cambio inicial",3,"ngModelChange","ngModel"],["class","err",4,"ngIf"],[1,"err"]],template:function(e,r){e&1&&(i(0,"div",1)(1,"div",2)(2,"h2"),a(3,"TPV"),n(),i(4,"p",3),a(5,"Selecciona el TPV con el que vas a operar. Cada TPV tiene su propia sesi\xF3n."),n(),i(6,"div",4)(7,"button",5),u("click",function(){return r.showNew.set(!0)}),a(8,"Nuevo TPV"),n()()(),i(9,"div",6),x(10,ie,14,3,"div",7),n(),x(11,re,17,3,"div",8)(12,se,17,3,"div",8)(13,pe,45,10,"div",8)(14,_e,6,2,"div",9)(15,xe,2,0,"p",10),n()),e&2&&(l(10),g("ngForOf",r.registers()),l(),g("ngIf",r.showNew()),l(),g("ngIf",r.showEditModal()),l(),g("ngIf",r.showConfigModal()),l(),g("ngIf",r.selectedId()),l(),g("ngIf",!r.selectedId()))},dependencies:[F,I,W,X,K,Q,U,H,B,J,G,q,R,D],styles:[".wrap[_ngcontent-%COMP%]{max-width:860px;margin:22px auto;padding:0 14px}.head[_ngcontent-%COMP%]   h2[_ngcontent-%COMP%]{margin:0;font-size:22px}.muted[_ngcontent-%COMP%]{color:#666;margin:6px 0 14px;font-size:14px}.list[_ngcontent-%COMP%]{display:grid;gap:10px;margin-bottom:16px}.item[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:12px 14px;border:1px solid #e5e5e5;border-radius:14px;background:#fff}.item.active[_ngcontent-%COMP%]{border-color:#111;box-shadow:0 6px 18px #0000000f}.title[_ngcontent-%COMP%]{font-weight:600}.sub[_ngcontent-%COMP%]{margin-top:4px;color:#666;font-size:13px}code[_ngcontent-%COMP%]{background:#f6f6f6;padding:2px 6px;border-radius:6px}.btn[_ngcontent-%COMP%]{padding:9px 12px;border-radius:10px;border:1px solid #ddd;background:#fff;cursor:pointer}.btn.primary[_ngcontent-%COMP%]{background:#111;color:#fff;border-color:#111}.panel[_ngcontent-%COMP%]{padding:14px;border:1px dashed #cfcfcf;border-radius:14px;background:#fff}.grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin:10px 0 12px}label[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{display:block;font-size:12px;color:#555;margin-bottom:6px}input[_ngcontent-%COMP%]{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #dcdcdc}.ok[_ngcontent-%COMP%]{display:grid;gap:8px}.small[_ngcontent-%COMP%]{font-size:12px;color:#666}.hint[_ngcontent-%COMP%]{display:block;margin-top:6px;font-size:12px;color:#666}.hint[_ngcontent-%COMP%]   a[_ngcontent-%COMP%]{color:#111;text-decoration:underline}.err[_ngcontent-%COMP%]{margin:10px 0 0;color:#b00020;font-size:13px}@media(max-width:680px){.grid[_ngcontent-%COMP%]{grid-template-columns:1fr}}.grid[_ngcontent-%COMP%]{display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;margin-top:16px}.tpv-card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow:var(--shadow-sm);position:relative}.card-header[_ngcontent-%COMP%]{position:absolute;top:8px;right:8px}.menu-btn[_ngcontent-%COMP%]{background:transparent;border:none;font-size:18px;cursor:pointer;padding:4px}.dropdown[_ngcontent-%COMP%]{position:absolute;top:100%;right:0;background:#fff;border:1px solid var(--border);border-radius:8px;box-shadow:0 4px 12px #00000026;z-index:1000;min-width:120px;margin-top:4px}.dropdown[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{display:block;width:100%;padding:8px 12px;border:none;background:transparent;text-align:left;cursor:pointer;border-radius:4px}.dropdown[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:#f5f5f5}.card-body[_ngcontent-%COMP%]{text-align:center;padding-top:20px}.title[_ngcontent-%COMP%]{font-size:18px;font-weight:600;margin-bottom:8px}.code[_ngcontent-%COMP%]{margin-bottom:16px}.btn.large[_ngcontent-%COMP%]{padding:12px 24px;font-size:16px}.modal[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#00000080;display:flex;align-items:center;justify-content:center;z-index:1000}.modal-content[_ngcontent-%COMP%]{background:#fff;border-radius:16px;padding:0;max-width:500px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:0 10px 30px #0000004d}.modal-header[_ngcontent-%COMP%]{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;border-bottom:1px solid var(--border)}.modal-header[_ngcontent-%COMP%]   h3[_ngcontent-%COMP%]{margin:0;font-size:18px}.close-btn[_ngcontent-%COMP%]{background:none;border:none;font-size:24px;cursor:pointer;color:#666}.close-btn[_ngcontent-%COMP%]:hover{color:#000}.modal-body[_ngcontent-%COMP%]{padding:20px}.checkbox-group[_ngcontent-%COMP%]{display:flex;flex-wrap:wrap;gap:10px}.checkbox-item[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;font-size:14px;font-weight:400}.checkbox-item[_ngcontent-%COMP%]   input[type=checkbox][_ngcontent-%COMP%]{margin:0}"]})};export{ee as TPVComponent};
