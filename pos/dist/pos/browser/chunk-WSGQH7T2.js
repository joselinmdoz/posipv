import{a as te}from"./chunk-W4NJFJ3E.js";import{a as H}from"./chunk-IJJ5UOPG.js";import{a as U}from"./chunk-OGHJEGVW.js";import{b as G,c as K,d as X,e as Y,f as J,g as Q,h as Z,i as $,j as ee}from"./chunk-5CMZHIZT.js";import"./chunk-XZ3PRBQD.js";import{Aa as A,Db as B,Ea as f,I as M,Ka as m,La as i,M as V,Ma as t,N as x,Na as P,Oa as S,Pa as E,Qa as c,S as g,T as u,Va as D,Xa as j,Ya as o,Za as p,ab as _,ba as v,bb as b,cb as y,gb as T,hb as k,ib as R,j as h,kb as N,pa as s,v as C,wb as W,xb as q,yb as L,zb as z}from"./chunk-EVJ26B7U.js";var O=class r{constructor(n){this.http=n}list(n){return this.http.get(`/api/cash-sessions/${encodeURIComponent(n)}/cash-movements`)}create(n,e){return this.http.post(`/api/cash-sessions/${encodeURIComponent(n)}/cash-movements`,e)}static \u0275fac=function(e){return new(e||r)(V(B))};static \u0275prov=M({token:r,factory:r.\u0275fac,providedIn:"root"})};var w="pos_cash_session_id:",I=class r{getCashSessionId(n){return localStorage.getItem(w+n)}setCashSessionId(n,e){localStorage.setItem(w+n,e)}clearCashSessionId(n){localStorage.removeItem(w+n)}clearAll(){Object.keys(localStorage).filter(n=>n.startsWith(w)).forEach(n=>localStorage.removeItem(n))}static \u0275fac=function(e){return new(e||r)};static \u0275prov=M({token:r,factory:r.\u0275fac,providedIn:"root"})};function oe(r,n){r&1&&(i(0,"span"),o(1,"\u2705 Abierta"),t())}function re(r,n){r&1&&o(0,"\u26A0\uFE0F Sin sesi\xF3n")}function ae(r,n){if(r&1&&(i(0,"div",14)(1,"div",3),o(2,"Apertura"),t(),i(3,"div",8),o(4),t(),i(5,"div",3),o(6),T(7,"date"),t()()),r&2){let e=n.ngIf,d=c();s(4),p(d.money(e.openingAmount)),s(2),p(k(7,2,e.openedAt,"short"))}}function se(r,n){r&1&&(i(0,"div",15)(1,"div",16),o(2,"No hay sesi\xF3n abierta"),t(),i(3,"div",3),o(4,"Abre la caja en la vista "),i(5,"b"),o(6,"Cajas"),t(),o(7," para habilitar movimientos y ventas."),t()())}function de(r,n){r&1&&(i(0,"span",3),o(1,"Procesando\u2026"),t())}function le(r,n){if(r&1&&(i(0,"div",37)(1,"div"),o(2),T(3,"date"),t(),i(4,"div")(5,"span",38),o(6),t()(),i(7,"div",30),o(8),t(),i(9,"div",3),o(10),t()()),r&2){let e=n.$implicit,d=c(2);s(2),p(k(3,6,e.createdAt,"short")),s(3),j(e.type),s(),p(e.type==="IN"?"Entrada":"Salida"),s(2),p(d.money(e.amount)),s(2),p(e.reason||"\u2014")}}function me(r,n){r&1&&(i(0,"div",39),o(1,"Sin movimientos."),t())}function ce(r,n){if(r&1){let e=S();i(0,"div",40)(1,"div",41),o(2),t(),i(3,"input",42),y("ngModelChange",function(a){let l=g(e).index,F=c(2);return b(F.denoms()[l].qty,a)||(F.denoms()[l].qty=a),u(a)}),t(),i(4,"div",43),o(5),t()()}if(r&2){let e=n.$implicit,d=n.index,a=c(2);s(2),p(a.money(e.value.toFixed(2))),s(),_("ngModel",a.denoms()[d].qty),s(2),p(a.money((e.value*e.qty).toFixed(2)))}}function pe(r,n){if(r&1){let e=S();i(0,"div")(1,"div",7)(2,"h2"),o(3,"Movimiento de dinero"),t(),i(4,"div",3),o(5,"Backend: "),i(6,"code"),o(7,"/api/cash-sessions/:id/cash-movements"),t()()(),i(8,"div",17)(9,"label")(10,"span"),o(11,"Tipo"),t(),i(12,"select",18),y("ngModelChange",function(a){g(e);let l=c();return b(l.movType,a)||(l.movType=a),u(a)}),i(13,"option",19),o(14,"Entrada"),t(),i(15,"option",20),o(16,"Salida"),t()()(),i(17,"label")(18,"span"),o(19,"Monto"),t(),i(20,"input",21),y("ngModelChange",function(a){g(e);let l=c();return b(l.movAmount,a)||(l.movAmount=a),u(a)}),t()(),i(21,"label",22)(22,"span"),o(23,"Motivo"),t(),i(24,"input",23),y("ngModelChange",function(a){g(e);let l=c();return b(l.movReason,a)||(l.movReason=a),u(a)}),t()(),i(25,"div",24)(26,"button",25),E("click",function(){g(e);let a=c();return u(a.createMovement())}),o(27,"Guardar"),t(),f(28,de,2,0,"span",26),t()(),i(29,"div",27)(30,"h2"),o(31,"Historial"),t()(),i(32,"div",28)(33,"div",29)(34,"div"),o(35,"Fecha"),t(),i(36,"div"),o(37,"Tipo"),t(),i(38,"div",30),o(39,"Monto"),t(),i(40,"div"),o(41,"Motivo"),t()(),f(42,le,11,9,"div",31)(43,me,2,0,"div",32),t(),P(44,"div",11),i(45,"div",7)(46,"h2"),o(47,"Cierre de caja"),t(),i(48,"div",3),o(49,"Registra lo contado por denominaciones (opcional) y cierra."),t()(),i(50,"div",33),f(51,ce,6,3,"div",34),t(),i(52,"div",7)(53,"div")(54,"div",3),o(55,"Total contado"),t(),i(56,"div",8),o(57),t()(),i(58,"div",14)(59,"button",35),E("click",function(){g(e);let a=c();return u(a.close())}),o(60,"Cerrar sesi\xF3n"),t()()(),i(61,"div",36),o(62," Nota: El fondo inicial (openingAmount) es para cambio y no deber\xEDa contarse como venta. "),t()()}if(r&2){let e=c();s(12),_("ngModel",e.movType),s(8),_("ngModel",e.movAmount),s(4),_("ngModel",e.movReason),s(2),m("disabled",e.busyMov()||!e.movAmount),s(2),m("ngIf",e.busyMov()),s(14),m("ngForOf",e.movements()),s(),m("ngIf",e.movements().length===0&&!e.busyList()),s(8),m("ngForOf",e.denoms()),s(6),p(e.money(e.countedTotal().toFixed(2))),s(2),m("disabled",e.busyClose())}}var ie=class r{reg=x(H);cash=x(te);cashMov=x(O);sessionStore=x(I);toast=x(U);registerId=N(()=>this.reg.selectedId());session=v(null);movements=v([]);busyList=v(!1);busyMov=v(!1);busyClose=v(!1);movType="IN";movAmount=null;movReason="";denoms=v([{value:1,qty:0},{value:5,qty:0},{value:10,qty:0},{value:20,qty:0},{value:50,qty:0},{value:100,qty:0}]);countedTotal=N(()=>this.denoms().reduce((n,e)=>n+e.value*e.qty,0));constructor(){this.reload()}reload(){let n=this.registerId();n&&this.cash.getOpen(n).pipe(C(()=>h(null))).subscribe(e=>{this.session.set(e),e?.id&&this.sessionStore.setCashSessionId(n,e.id),e?.id?this.loadMovements(e.id):this.movements.set([])})}loadMovements(n){this.busyList.set(!0),this.cashMov.list(n).pipe(C(()=>h([]))).subscribe(e=>{this.movements.set(e),this.busyList.set(!1)})}createMovement(){let n=this.session();!n||!this.movAmount||(this.busyMov.set(!0),this.cashMov.create(n.id,{type:this.movType,amount:Number(this.movAmount).toFixed(2),reason:this.movReason||null}).pipe(C(()=>(this.toast.push({kind:"error",title:"No se pudo guardar",message:"Verifica el backend"}),h(null)))).subscribe(e=>{e&&(this.toast.push({kind:"success",title:"Movimiento registrado",message:this.movType==="IN"?"Entrada":"Salida"}),this.movements.update(d=>[e,...d]),this.movAmount=null,this.movReason=""),this.busyMov.set(!1)}))}close(){let n=this.registerId(),e=this.session();if(!n||!e)return;let d=this.countedTotal();this.busyClose.set(!0),this.cash.close(e.id,d,"Cierre por denominaciones (frontend)").pipe(C(()=>(this.toast.push({kind:"error",title:"No se pudo cerrar",message:"Verifica /api/cash-sessions/:id/close"}),h(null)))).subscribe(a=>{this.toast.push({kind:"success",title:"Sesi\xF3n cerrada",message:"Caja cerrada correctamente"}),this.session.set(null),this.sessionStore.clearCashSessionId(n),this.busyClose.set(!1)})}money(n){let e=Number(n);return isFinite(e)?new Intl.NumberFormat(void 0,{style:"currency",currency:"USD"}).format(e):n}static \u0275fac=function(e){return new(e||r)};static \u0275cmp=A({type:r,selectors:[["ng-component"]],decls:29,vars:6,consts:[["noS",""],[1,"page"],[1,"page-head"],[1,"muted"],[1,"actions"],[1,"btn",3,"click"],[1,"card"],[1,"row"],[1,"big"],[4,"ngIf","ngIfElse"],["class","right",4,"ngIf"],[1,"divider"],["class","note",4,"ngIf"],[4,"ngIf"],[1,"right"],[1,"note"],[1,"b"],[1,"form"],[3,"ngModelChange","ngModel"],["value","IN"],["value","OUT"],["type","number","step","0.01",3,"ngModelChange","ngModel"],[1,"wide"],["placeholder","Ej: Cambio, compra de insumos, dep\xF3sito, retiro\u2026",3,"ngModelChange","ngModel"],[1,"row","wide"],[1,"btn","primary",3,"click","disabled"],["class","muted",4,"ngIf"],[1,"row","mt"],[1,"table"],[1,"th"],[1,"r"],["class","tr",4,"ngFor","ngForOf"],["class","empty",4,"ngIf"],[1,"denoms"],["class","den",4,"ngFor","ngForOf"],[1,"btn","danger",3,"click","disabled"],[1,"muted","mt"],[1,"tr"],[1,"pill"],[1,"empty"],[1,"den"],[1,"v"],["type","number","min","0","step","1",3,"ngModelChange","ngModel"],[1,"t","muted"]],template:function(e,d){if(e&1){let a=S();i(0,"div",1)(1,"div",2)(2,"div")(3,"h1"),o(4,"Caja"),t(),i(5,"p",3),o(6,"Entradas / salidas de dinero y cierre con denominaciones."),t()(),i(7,"div",4)(8,"button",5),E("click",function(){return g(a),u(d.reload())}),o(9,"Actualizar"),t()()(),i(10,"div",6)(11,"div",7)(12,"div")(13,"div",3),o(14,"Caja seleccionada"),t(),i(15,"div",8)(16,"code"),o(17),t()()(),i(18,"div")(19,"div",3),o(20,"Sesi\xF3n"),t(),i(21,"div",8),f(22,oe,2,0,"span",9)(23,re,1,0,"ng-template",null,0,R),t()(),f(25,ae,8,5,"div",10),t(),P(26,"div",11),f(27,se,8,0,"div",12)(28,pe,63,10,"div",13),t()()}if(e&2){let a=D(24);s(17),p(d.registerId()||"\u2014"),s(5),m("ngIf",d.session())("ngIfElse",a),s(3),m("ngIf",d.session()),s(2),m("ngIf",!d.session()),s(),m("ngIf",d.session())}},dependencies:[z,W,q,ee,Q,Z,G,Y,J,K,$,X,L],styles:[".page[_ngcontent-%COMP%]{padding:18px}.page-head[_ngcontent-%COMP%]{display:flex;justify-content:space-between;gap:16px;align-items:flex-end;flex-wrap:wrap}h1[_ngcontent-%COMP%]{margin:0;font-size:24px;letter-spacing:-.02em}h2[_ngcontent-%COMP%]{margin:0;font-size:16px}.muted[_ngcontent-%COMP%]{color:var(--muted)}.actions[_ngcontent-%COMP%]{display:flex;gap:10px}.btn[_ngcontent-%COMP%]{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#fff;cursor:pointer}.btn.primary[_ngcontent-%COMP%]{background:var(--brand);color:#fff;border-color:transparent}.btn.danger[_ngcontent-%COMP%]{background:#842029;color:#fff;border-color:transparent}.card[_ngcontent-%COMP%]{background:#fff;border:1px solid var(--border);border-radius:16px;padding:14px;box-shadow:var(--shadow-sm);margin-top:12px}.row[_ngcontent-%COMP%]{display:flex;align-items:flex-end;justify-content:space-between;gap:12px;flex-wrap:wrap}.right[_ngcontent-%COMP%]{margin-left:auto;text-align:right}.big[_ngcontent-%COMP%]{font-weight:900;font-size:16px;margin-top:6px}.divider[_ngcontent-%COMP%]{height:1px;background:var(--border);margin:12px 0}.note[_ngcontent-%COMP%]{padding:12px;border-radius:14px;border:1px solid rgba(255,193,7,.25);background:#ffc10714}.b[_ngcontent-%COMP%]{font-weight:900}.form[_ngcontent-%COMP%]{margin-top:10px;display:grid;grid-template-columns:.6fr .6fr 1.8fr;gap:10px}.wide[_ngcontent-%COMP%]{grid-column:1/-1}@media(max-width:980px){.form[_ngcontent-%COMP%]{grid-template-columns:1fr}}label[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px;font-size:12px;color:var(--muted)}input[_ngcontent-%COMP%], select[_ngcontent-%COMP%]{padding:10px;border-radius:12px;border:1px solid var(--border);outline:none;background:#fff}.mt[_ngcontent-%COMP%]{margin-top:12px}.table[_ngcontent-%COMP%]{margin-top:10px;border:1px solid var(--border);border-radius:14px;overflow:hidden}.th[_ngcontent-%COMP%], .tr[_ngcontent-%COMP%]{display:grid;grid-template-columns:1.1fr .7fr .7fr 2fr;gap:10px;padding:10px 12px;align-items:center}@media(max-width:980px){.th[_ngcontent-%COMP%], .tr[_ngcontent-%COMP%]{grid-template-columns:1.1fr .7fr .8fr}.th[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]:nth-child(4), .tr[_ngcontent-%COMP%]   div[_ngcontent-%COMP%]:nth-child(4){display:none}}.th[_ngcontent-%COMP%]{background:#fafafa;font-size:12px;color:var(--muted);font-weight:700}.tr[_ngcontent-%COMP%]{border-top:1px solid var(--border)}.r[_ngcontent-%COMP%]{text-align:right;font-variant-numeric:tabular-nums}.empty[_ngcontent-%COMP%]{padding:14px;color:var(--muted)}.pill[_ngcontent-%COMP%]{display:inline-flex;padding:2px 10px;border-radius:999px;border:1px solid var(--border);background:#fafafa;font-size:12px;font-weight:800}.pill.IN[_ngcontent-%COMP%]{background:#1987541a;border-color:#19875440}.pill.OUT[_ngcontent-%COMP%]{background:#dc35451a;border-color:#dc354540}.denoms[_ngcontent-%COMP%]{margin-top:10px;display:grid;grid-template-columns:repeat(6,minmax(0,1fr));gap:10px}@media(max-width:1100px){.denoms[_ngcontent-%COMP%]{grid-template-columns:repeat(3,minmax(0,1fr))}}@media(max-width:640px){.denoms[_ngcontent-%COMP%]{grid-template-columns:repeat(2,minmax(0,1fr))}}.den[_ngcontent-%COMP%]{border:1px solid var(--border);border-radius:14px;padding:10px}.den[_ngcontent-%COMP%]   .v[_ngcontent-%COMP%]{font-weight:900}.den[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:100%;margin-top:8px}.den[_ngcontent-%COMP%]   .t[_ngcontent-%COMP%]{margin-top:6px;font-size:12px}code[_ngcontent-%COMP%]{background:#f6f6f6;border:1px solid #eee;padding:2px 6px;border-radius:10px}"]})};export{ie as CashComponent};
