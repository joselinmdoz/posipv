import{d as u}from"./chunk-EKOQI3CN.js";import{a as h}from"./chunk-OGHJEGVW.js";import{a as c}from"./chunk-XZ3PRBQD.js";import{Db as l,I as n,N as r,g as a}from"./chunk-EVJ26B7U.js";var d=class i{http=r(l);router=r(u);toast=r(h);userSubject=new a(null);user$=this.userSubject.asObservable();idleListeners=[];idleTimer=null;warnTimer=null;warned=!1;IDLE_MS=120*1e3;WARN_BEFORE_MS=30*1e3;constructor(){let t=localStorage.getItem("token"),e=localStorage.getItem("user");if(t&&e)try{this.userSubject.next(JSON.parse(e)),this.startIdleWatch()}catch{}}isLoggedIn(){return!!localStorage.getItem("token")}token(){return localStorage.getItem("token")}user(){return this.userSubject.value}login(t,e){return this.http.post(`${c}/api/auth/login`,{email:t,password:e})}setSession(t,e){localStorage.setItem("token",t),localStorage.setItem("user",JSON.stringify(e)),this.userSubject.next(e),this.startIdleWatch()}logout(){localStorage.removeItem("token"),localStorage.removeItem("user"),this.userSubject.next(null),this.stopIdleWatch(),this.router.navigateByUrl("/login")}startIdleWatch(){this.stopIdleWatch(),this.warned=!1;let t=()=>this.scheduleIdleTimers(),e=s=>{let o=()=>t();window.addEventListener(s,o,{passive:!0}),this.idleListeners.push(()=>window.removeEventListener(s,o))};e("mousemove"),e("mousedown"),e("keydown"),e("touchstart"),e("scroll"),this.scheduleIdleTimers()}stopIdleWatch(){this.idleListeners.forEach(t=>t()),this.idleListeners=[],this.idleTimer&&clearTimeout(this.idleTimer),this.warnTimer&&clearTimeout(this.warnTimer),this.idleTimer=null,this.warnTimer=null,this.warned=!1}scheduleIdleTimers(){this.isLoggedIn()&&(this.idleTimer&&clearTimeout(this.idleTimer),this.warnTimer&&clearTimeout(this.warnTimer),this.warned=!1,this.warnTimer=setTimeout(()=>{this.isLoggedIn()&&(this.warned=!0,this.toast.push({kind:"warning",title:"Inactividad",message:"En 30 segundos se cerrar\xE1 la sesi\xF3n. Mueve el mouse o presiona una tecla para continuar.",timeoutMs:9e3}))},Math.max(0,this.IDLE_MS-this.WARN_BEFORE_MS)),this.idleTimer=setTimeout(()=>{this.isLoggedIn()&&(this.toast.push({kind:"info",title:"Sesi\xF3n cerrada",message:"Se cerr\xF3 por inactividad.",timeoutMs:5e3}),this.logout())},this.IDLE_MS))}static \u0275fac=function(e){return new(e||i)};static \u0275prov=n({token:i,factory:i.\u0275fac,providedIn:"root"})};export{d as a};
