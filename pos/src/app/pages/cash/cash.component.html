<div class="page">
  <div class="page-head">
    <div>
      <h1>Caja</h1>
      <p class="muted">Entradas / salidas de dinero y cierre con denominaciones.</p>
    </div>
    <div class="actions">
      <button class="btn" (click)="reload()">Actualizar</button>
    </div>
  </div>

  <div class="card">
    <div class="row">
      <div>
        <div class="muted">Caja seleccionada</div>
        <div class="big"><code>{{ registerId() || '—' }}</code></div>
      </div>
      <div>
        <div class="muted">Sesión</div>
        <div class="big">
          <span *ngIf="session(); else noS">✅ Abierta</span>
          <ng-template #noS>⚠️ Sin sesión</ng-template>
        </div>
      </div>
      <div class="right" *ngIf="session() as s">
        <div class="muted">Apertura</div>
        <div class="big">{{ money(s.openingAmount) }}</div>
        <div class="muted">{{ s.openedAt | date:'short' }}</div>
      </div>
    </div>

    <div class="divider"></div>

    <div *ngIf="!session()" class="note">
      <div class="b">No hay sesión abierta</div>
      <div class="muted">Abre la caja en la vista <b>Cajas</b> para habilitar movimientos y ventas.</div>
    </div>

    <div *ngIf="session() as s">
      <div class="row">
        <h2>Movimiento de dinero</h2>
        <div class="muted">Backend: <code>/api/cash-sessions/:id/cash-movements</code></div>
      </div>

      <div class="form">
        <label>
          <span>Tipo</span>
          <select [(ngModel)]="movType">
            <option value="IN">Entrada</option>
            <option value="OUT">Salida</option>
          </select>
        </label>
        <label>
          <span>Monto</span>
          <input [(ngModel)]="movAmount" type="number" step="0.01" />
        </label>
        <label class="wide">
          <span>Motivo</span>
          <input [(ngModel)]="movReason" placeholder="Ej: Cambio, compra de insumos, depósito, retiro…" />
        </label>
        <div class="row wide">
          <button class="btn primary" (click)="createMovement()" [disabled]="busyMov() || !movAmount">Guardar</button>
          <span class="muted" *ngIf="busyMov()">Procesando…</span>
        </div>
      </div>

      <div class="row mt">
        <h2>Historial</h2>
      </div>

      <div class="table">
        <div class="th">
          <div>Fecha</div>
          <div>Tipo</div>
          <div class="r">Monto</div>
          <div>Motivo</div>
        </div>
        <div class="tr" *ngFor="let m of movements()">
          <div>{{ m.createdAt | date:'short' }}</div>
          <div><span class="pill" [class]="m.type">{{ m.type==='IN' ? 'Entrada' : 'Salida' }}</span></div>
          <div class="r">{{ money(m.amount) }}</div>
          <div class="muted">{{ m.reason || '—' }}</div>
        </div>
        <div class="empty" *ngIf="movements().length===0 && !busyList()">Sin movimientos.</div>
      </div>

      <div class="divider"></div>

      <div class="row">
        <h2>Cierre de caja</h2>
        <div class="muted">Registra lo contado por denominaciones (opcional) y cierra.</div>
      </div>

      <div class="denoms">
        <div class="den" *ngFor="let d of denoms(); let i = index">
          <div class="v">{{ money(d.value.toFixed(2)) }}</div>
          <input [(ngModel)]="denoms()[i].qty" type="number" min="0" step="1" />
          <div class="t muted">{{ money((d.value * d.qty).toFixed(2)) }}</div>
        </div>
      </div>

      <div class="row">
        <div>
          <div class="muted">Total contado</div>
          <div class="big">{{ money(countedTotal().toFixed(2)) }}</div>
        </div>
        <div class="right">
          <button class="btn danger" (click)="close()" [disabled]="busyClose()">Cerrar sesión</button>
        </div>
      </div>

      <div class="muted mt">
        Nota: El fondo inicial (openingAmount) es para cambio y no debería contarse como venta.
      </div>
    </div>
  </div>
</div>