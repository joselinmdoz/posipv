<div class="wrap">
  <div class="head">
    <h2>TPV</h2>
    <p class="muted">Selecciona el TPV con el que vas a operar. Cada TPV tiene su propia sesión.</p>
    <div class="actions">
      <button class="btn primary" (click)="showNew.set(true)">Nuevo TPV</button>
    </div>
  </div>

  <div class="grid">
    <div class="tpv-card" *ngFor="let r of registers()">
      <div class="card-header">
        <div class="menu">
          <button class="menu-btn" (click)="toggleMenu(r.id)">⋮</button>
          <div class="dropdown" *ngIf="openMenu() === r.id">
            <button (click)="configure(r)">Configurar</button>
            <button (click)="edit(r)">Editar</button>
            <button (click)="delete(r)">Eliminar</button>
          </div>
        </div>
      </div>
      <div class="card-body">
        <div class="title">{{ r.name }}</div>
        <div class="code"><code>{{ r.code }}</code></div>
        <button class="btn primary large" (click)="select(r)">Iniciar Sesión</button>
      </div>
    </div>
  </div>

  <!-- Modal Crear TPV -->
  <div class="modal" *ngIf="showNew()">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Crear TPV</h3>
        <button class="close-btn" (click)="closeModals()">×</button>
      </div>
      <div class="modal-body">
        <div class="form">
          <label>
            <span>Nombre</span>
            <input [(ngModel)]="newName" placeholder="Ej: TPV Principal" />
          </label>
          <div class="row">
            <button class="btn primary" (click)="create()" [disabled]="busy() || !newName">Guardar</button>
            <span class="muted" *ngIf="busy()">Guardando…</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Editar TPV -->
  <div class="modal" *ngIf="showEditModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Editar TPV</h3>
        <button class="close-btn" (click)="closeModals()">×</button>
      </div>
      <div class="modal-body">
        <div class="form">
          <label>
            <span>Nombre</span>
            <input [(ngModel)]="newName" placeholder="Ej: TPV Principal" />
          </label>
          <div class="row">
            <button class="btn primary" (click)="saveEdit()" [disabled]="busy() || !newName">Guardar</button>
            <span class="muted" *ngIf="busy()">Guardando…</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Configurar TPV -->
  <div class="modal" *ngIf="showConfigModal()">
    <div class="modal-content">
      <div class="modal-header">
        <h3>Configurar TPV</h3>
        <button class="close-btn" (click)="closeModals()">×</button>
      </div>
      <div class="modal-body">
        <p class="muted" *ngIf="configTPV">Configuración para: <b>{{ configTPV.name }}</b></p>
        <div class="form">
          <label>
            <span>Tipo de moneda</span>
            <select [(ngModel)]="configCurrency">
              <option value="CUP">CUP - Peso cubano</option>
              <option value="USD">USD - Dólar estadounidense</option>
            </select>
          </label>
          <label>
            <span>Almacén</span>
            <span class="warehouse-display">{{ configWarehouseName() }}</span>
          </label>
          <label>
            <span>Métodos de pago</span>
            <div class="checkbox-group">
              <label class="checkbox-item">
                <input type="checkbox" [(ngModel)]="configPaymentMethods" value="EFECTIVO" />
                Efectivo
              </label>
              <label class="checkbox-item">
                <input type="checkbox" [(ngModel)]="configPaymentMethods" value="TRANSFERENCIA" />
                Transferencia
              </label>
              <label class="checkbox-item">
                <input type="checkbox" [(ngModel)]="configPaymentMethods" value="TARJETA" />
                Tarjeta
              </label>
            </div>
          </label>
          <label>
            <span>Denominaciones</span>
            <div class="checkbox-group">
              <label class="checkbox-item" *ngFor="let denom of [1, 5, 10, 20, 50, 100]">
                <input type="checkbox" [(ngModel)]="configDenominations" [value]="denom" />
                {{ denom }}
              </label>
            </div>
          </label>
          <div class="row">
            <button class="btn primary" (click)="saveConfig()" [disabled]="busy()">Guardar</button>
            <span class="muted" *ngIf="busy()">Guardando…</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel" *ngIf="selectedId()">
    <h3>Sesión de caja</h3>

    <div *ngIf="openSession(); else openBox" class="ok">
      ✅ Sesión abierta ({{ openSession()?.openedAt | date:'short' }})
      <div class="small">ID: <code>{{ openSession()?.id }}</code></div>
      <button class="btn primary" (click)="goPos()">Ir al POS</button>
    </div>

    <ng-template #openBox>
      <div class="grid">
        <label>
          <span>Monto inicial (fijo)</span>
          <input type="number" step="0.01" [(ngModel)]="opening" [disabled]="!isAdmin()" />
          <small class="hint">Se configura por caja en <a routerLink="/settings">Configuración</a>.</small>
        </label>
        <label>
          <span>Nota (opcional)</span>
          <input [(ngModel)]="note" placeholder="Ej: Cambio inicial" />
        </label>
      </div>

      <button class="btn primary" (click)="open()" [disabled]="busy()">{{ busy() ? 'Abriendo…' : 'Abrir caja' }}</button>
      <p class="err" *ngIf="err()">{{ err() }}</p>
    </ng-template>
  </div>

  <p class="muted" *ngIf="!selectedId()">Tip: si tienes varias cajas físicas, dales un nombre claro (Caja 1, Caja 2…).</p>
</div>